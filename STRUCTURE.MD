## ğŸ“‚ General Folder Structure

```
src/
â”œâ”€ domain/
â”‚   â”œâ”€ entities/
â”‚   â”‚   â”œâ”€ watcher.ts
â”‚   â”‚   â””â”€ wallet.ts
â”‚   â”œâ”€ value-objects/
â”‚   â”‚   â”œâ”€ threshold.ts
â”‚   â”‚   â””â”€ frequency.ts
â”‚   â”œâ”€ errors/
â”‚   â”‚   â””â”€ domain-errors.ts
â”‚   â””â”€ interfaces/
â”‚       â”œâ”€ i-watcher-repository.ts
â”‚       â”œâ”€ i-wallet-repository.ts
â”‚       â”œâ”€ i-metlex-mapper.ts
â”‚       â””â”€ i-lpagent-client.ts
â”‚
â”œâ”€ application/
â”‚   â”œâ”€ use-cases/
â”‚   â”‚   â”œâ”€ add-watcher.use-case.ts
â”‚   â”‚   â”œâ”€ edit-watcher.use-case.ts
â”‚   â”‚   â”œâ”€ remove-watcher.use-case.ts
â”‚   â”‚   â”œâ”€ list-watchers.use-case.ts
â”‚   â”‚   â”œâ”€ process-closed-message.use-case.ts
â”‚   â”‚   â”œâ”€ add-wallet.use-case.ts
â”‚   â”‚   â”œâ”€ toggle-wallet.use-case.ts
â”‚   â”‚   â””â”€ summary-wallet.use-case.ts
â”‚   â”œâ”€ dtos/
â”‚   â”‚   â”œâ”€ add-watcher.dto.ts
â”‚   â”‚   â””â”€ wallet-summary.dto.ts
â”‚   â””â”€ errors/
â”‚       â””â”€ application-errors.ts
â”‚
â”œâ”€ infrastructure/
â”‚   â”œâ”€ repositories/
â”‚   â”‚   â”œâ”€ dynamo-watcher-repository.ts
â”‚   â”‚   â””â”€ dynamo-wallet-repository.ts
â”‚   â”œâ”€ services/
â”‚   â”‚   â”œâ”€ discord-adapter.ts
â”‚   â”‚   â”œâ”€ metlex-mapper.ts
â”‚   â”‚   â”œâ”€ lpagent-client.ts
â”‚   â”‚   â””â”€ canvas-renderer.ts
â”‚   â””â”€ config/
â”‚       â”œâ”€ env.ts
â”‚       â””â”€ aws.ts
â”‚
â”œâ”€ presentation/
â”‚   â”œâ”€ commands/
â”‚   â”‚   â”œâ”€ follow.command.ts
â”‚   â”‚   â”œâ”€ unfollow.command.ts
â”‚   â”‚   â”œâ”€ watchers.command.ts
â”‚   â”‚   â”œâ”€ watch.command.ts
â”‚   â”‚   â”œâ”€ unwatch.command.ts
â”‚   â”‚   â”œâ”€ follows.command.ts
â”‚   â”‚   â””â”€ clear.command.ts
â”‚   â”œâ”€ listeners/
â”‚   â”‚   â””â”€ closed-message.listener.ts
â”‚   â”œâ”€ components/
â”‚   â”‚   â”œâ”€ add-watcher.modal.ts
â”‚   â”‚   â”œâ”€ edit-watcher.modal.ts
â”‚   â”‚   â”œâ”€ add-wallet.modal.ts
â”‚   â”‚   â””â”€ manage-wallet.select-menu.ts
â”‚   â””â”€ utils/
â”‚       â”œâ”€ embed-builder.ts
â”‚       â””â”€ interaction-collector.ts
â”‚
â”œâ”€ schemas/
â”‚   â”œâ”€ metlex-link.schema.ts
â”‚   â”œâ”€ position-response.schema.ts
â”‚   â””â”€ command-options.schema.ts
â”‚
â”œâ”€ shared/
â”‚   â”œâ”€ logger.ts
â”‚   â””â”€ error-handler.ts
â”‚
â”œâ”€ injection/
â”‚   â””â”€ container.ts
â”‚
â””â”€ index.ts
```

---

## ğŸ” Layer Details

### 1. **Domain**

* **Entities**: Pure classes (`Watcher`, `Wallet`) encapsulating business rules.
* **Value objects**: `Threshold`, `Frequency` to ensure validity (Â±%, DAY/WEEK/MONTH).
* **Interfaces**: Abstractions (`IWatcherRepository`, `IMetlexMapper`, etc.) â€“ no mention of DynamoDB or Discord here.
* **Errors**: Typed business exceptions.

### 2. **Application**

* **Use cases**: Each interaction or business workflow (e.g., `AddWatcher`, `ProcessClosedMessage`).
* **DTOs**: Transfer objects validated with Zod (e.g., `AddWatcherDto`).
* **Errors**: Handles execution errors (repository, validation, etc.).

### 3. **Infrastructure**

* **Repositories**: Concrete implementations of `IWatcherRepository` and `IWalletRepository` using DynamoDB (AWS SDK v3, single-table).
* **External services**:

  * `DiscordAdapter` (sending embeds, modals, components).
  * `MetlexMapper` (caching MetlexHash â†’ tx).
  * `LpagentClient` (typed HTTP requests with retry).
  * `CanvasRenderer` (optional PnL image generation).
* **Config**: Centralization of environment variables and AWS/Discord configuration.

### 4. **Presentation**

* **Slash commands** (in `commands/`): Parse options, call the corresponding use case, return a clean response (`ephemeral` / embed).
* **Listeners**: `closed-message.listener.ts` subscribes to the `messageCreate` event, filters, and triggers `ProcessClosedMessageUseCase`.
* **Components**: Buttons, menus, modals, handled by `InteractionCollector` to chain UI â†’ business logic.
* **Utils**: Custom `EmbedBuilder`, interaction wrapper to simplify code.

### 5. **Schemas**

* **Zod** in every DTO and for validating `lpagent.io` API responses and Metlex URLs.
* Ensures *strict typing* everywhere, *no* untyped `any`.

### 6. **Shared**

* Central **Logger** (`winston` or `pino`) with levels (`info`, `error`).
* Global **Error handler** to catch rejected promises and log cleanly.

### 7. **Injection**

* **DI container** (e.g., `tsyringe`) in `injection/container.ts`: injects repositories, services, and use cases into the handlers to facilitate unit testing.

---

## ğŸ› ï¸ Best Practices & Conventions

* **Files & folders**: `kebab-case` everywhere (`add-watcher.use-case.ts`, not `AddWatcherUseCase.ts`).
* **TypeScript**:

  * `"strict": true` in `tsconfig.json`.
  * No `any`, only `unknown` followed by Zod validation.
* **Clean code**:

  * Functions â‰¤ 20 lines, classes â‰¤ 200 lines.
  * One responsibility per module.
* **Testing**:

  * Unit tests for each use case & service (Jest + ts-jest).
  * Interface mocks to isolate the business layer.
* **Lint & format**: ESLint + Prettier with Airbnb rules adapted for TypeScript.

---

If you want, I can also provide an English diagram or visual representation of this architecture to make it clearer. Want me to?
